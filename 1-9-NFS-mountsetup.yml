---
- name: Setup NFS mounts for all hosts
  hosts: manualtarget
  become: true
  vars:
    nfs_server: "192.168.0.4"
    nfs_mounts:
      - { share: "/volume1/docker", mount_point: "/mnt/dsm_nfs_ds918_docker" }
      - { share: "/volume1/music", mount_point: "/mnt/dsm_nfs_music" }
      - { share: "/volume1/zzDownload", mount_point: "/mnt/dsm_nfs_zdownload" }
      - { share: "/volume1/video", mount_point: "/mnt/dsm_nfs_video" }
    nfs_options: "rw,vers=4,nofail,_netdev,x-systemd.automount"

  tasks:
    - name: Install required NFS client package
      package:
        name: "{{ 'nfs-common' if ansible_os_family == 'Debian' else 'nfs-utils' }}"
        state: present

    - name: Ensure all NFS mount points exist
      file:
        path: "{{ item.mount_point }}"
        state: directory
        mode: '0755'
      loop: "{{ nfs_mounts }}"

    - name: Ensure fstab entries exist for NFS mounts
      mount:
        src: "{{ nfs_server }}:{{ item.share }}"
        path: "{{ item.mount_point }}"
        fstype: nfs
        opts: "{{ nfs_options }}"
        state: present
        fstab: yes
      loop: "{{ nfs_mounts }}"

    - name: Mount the NFS shares (skipped during dry run)
      mount:
        src: "{{ nfs_server }}:{{ item.share }}"
        path: "{{ item.mount_point }}"
        fstype: nfs
        opts: "{{ nfs_options }}"
        state: mounted
      when: not ansible_check_mode
      loop: "{{ nfs_mounts }}"
