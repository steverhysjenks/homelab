---
- name: Mount DSM NFS and migrate Docker data
  hosts: targeted_old_host
  become: true
  vars:
    nfs_server: "192.168.0.4"
    nfs_share: "/volume1/docker"
    mount_point: "/mnt/dsm_docker"
    source_docker_dir: "/docker"

  tasks:
    - name: Install required NFS client package
      package:
        name: "{{ nfs_package }}"
        state: present
      vars:
        nfs_package: >-
          {% if ansible_os_family == 'Debian' %}
            nfs-common
          {% elif ansible_os_family in ['Archlinux', 'Alpine'] %}
            nfs-utils
          {% else %}
            nfs-common
          {% endif %}

    - name: Ensure mount point exists
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount NFS share
      mount:
        src: "{{ nfs_server }}:{{ nfs_share }}"
        path: "{{ mount_point }}"
        fstype: nfs
        opts: rw,vers=4
        state: mounted

    - name: Copy container data from /root/docker to /mnt/dsm_docker
      synchronize:
        src: "{{ source_docker_dir }}/"
        dest: "{{ mount_point }}/"
        recursive: true
        rsync_opts:
          - "--archive"
          - "--delete"
          - "--no-times"
      delegate_to: "{{ inventory_hostname }}"
      tags: migrate

    - name: Reminder to update docker-compose paths
      debug:
        msg: |
          âœ… Docker data has been migrated to {{ mount_point }}.
          Update any docker-compose or Portainer volumes to use:
          {{ mount_point }}/<container-name>
